<link rel="import" href="../../../../../polymer-d3/polymer-d3.html">
<dom-module id="zeppelin-chart-manager">
  <template>
    <polymer-d3 source="[[source]]" paragraph-id="[[paragraphId]]"></polymer-d3>
  </template>
  <script>
  class zeppelinChartManager extends ZeppelinReduxMixin(Polymer.Element) {
    static get is() {
      return 'zeppelin-chart-manager'
    }
    static get properties() {
      return {
        source: {
          type: Object,
          value: {}
        },
        paragraphId:{
          type:String,
          statePath(state){
            return state.notebook.paragraphs[this.index].id;
          }
        }
      }
    }
    static get observers() {
      return ['transformData(paragraphId)']
    }

    transformData() {
      var me = this;
      let sourceObj={
        source:[],
        externals:[]
      }
      // if (data) {
      var data = this.response.replace();
      var headerObj = [];
      var lines = data.split('\n');
      var result = [];
      var headers = lines[0].split('\t');
      var firstRow = lines[1].split('\t');

      headers.forEach(function(el, key) {
        var type = me.getDataType(firstRow[key]);
        headerObj.push({
          key: headers[key],
          value: key,
          type: type
        });
      });

      // me.set('externals', headerObj);

      // this.dispatch({type:'SET_EXTERNAL',payload:{id:this.paragraphId,externals:headerObj}});

      // lines.length - 1 is used because, last row is always just a '\n' with no data
      for (var i = 1; i < lines.length - 1; i++) {
        var obj = [];
        var currentline = lines[i].split('\t');
        for (var j = 0; j < headers.length; j++) {
          var converted = me.convertData(currentline[j], headerObj[j].type);
          obj.push(converted);
        }

        result.push(obj);
      }
      sourceObj.externals = headerObj;
      sourceObj.source = result;
      this.set('source',sourceObj);
    }
    getDataType(data) {
      var result = '';
      if (data.match(/^\d*\.?\d*$/g)) {
        result = 'Number';
      } else if (Date.parse(data)) {
        result = 'Date';
      } else {
        result = 'String';
      }
      return result;
    }

    convertData(data, type) {
      var result;
      switch (type) {
        case 'Number':
          result = parseFloat(data);
          break;
        case 'Date':
          result = new Date(data);
          break;
        default:
          result = data;
      }
      return result;
    }
  }
  window.customElements.define(zeppelinChartManager.is, zeppelinChartManager);
  </script>
  <!-- <script src="zeppelin-chart-manager.js"></script> -->
</dom-module>
