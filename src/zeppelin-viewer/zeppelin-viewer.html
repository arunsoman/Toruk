<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<!-- externals -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/web-socket/web-socket.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<!-- modules -->
<link rel="import" href="../zeppelin-behaviours/zeppelin-behaviours.html">
<link rel="import" href="../zeppelin-notebooks/zeppelin-notebooks.html">
<link rel="import" href="../zeppelin-notebook/zeppelin-notebook.html">
<link rel="import" href="../zeppelin-groups/zeppelin-groups.html">
<dom-module id="zeppelin-viewer">
  <template>
    <style>
    :host {
      background: #d8dce3;
      display: block;
      overflow: hidden;
    }
    </style>
    <iron-ajax url="[[ajaxUrl]]/api/login?password=password1&userName=admin" method="POST" on-response="handleResponse" handle-as="json" debounce-duration="300" id="ajaxUrl"></iron-ajax>
    <web-socket id="socket" url="[[socketUrl]]/ws" json on-open="_onOpen" on-close="_onClose" on-message="handleSocketResponse" on-error="_onError"></web-socket>
    <div class="table-wrapper">
      <template is="dom-if" if="{{ eq(view,'group') }}" restamp>
        <zeppelin-groups></zeppelin-groups>
      </template>
      <template is="dom-if" if="{{ eq(view,'lists') }}" restamp>
        <zeppelin-notebooks></zeppelin-notebooks>
      </template>
      <template is="dom-if" if="{{ eq(view,'single') }}">
        <zeppelin-notebook></zeppelin-notebook>
      </template>
    </div>
  </template>
  <script>
  class ZeppelinViewer extends Polymer.mixinBehaviors([ZEPPELIN_BEHAVIORS], ZeppelinReduxMixin(Polymer.Element)) {
    static get is() {
      return 'zeppelin-viewer'
    }
    static get properties() {
      return {
        hostIp:{
          type:String
        },
        hostPort:{
          type:String
        },
        socketUrl: {
          type: String
        },
        wsData: {
          type: Object,
          statePath: 'ws.post'
        },
        authObj: {
          type: Object,
          statePath: 'ws.auth'
        },
        view: {
          type: String,
          statePath: 'view'
        }
      };
    }
    static get observers() {
      return ['sendData(wsData)', 'authChange(authObj)','createUrl(hostIp)']
    }
    createUrl(host){
      if(!host) return;
      var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.socketUrl = protocol + '//' + this.hostIp+':'+this.hostPort;
      this.set('ajaxUrl',window.location.protocol+'//'+this.hostIp+':'+this.hostPort);
      this.$.ajaxUrl.generateRequest();
    }
    add() {
      this.dispatch({
        type: 'UPDATE_VIEW',
        payload: new Date()
      })
    }
    handleResponse(response) {
      this.dispatch({
        type: 'SET_AUTH',
        payload: response.detail.response.body
      })
    }
    authChange() {
      this.$.socket.open();
    }
    _onOpen() {
      this.pingSocket();
      this.set('socketEnable', true);
      this.getNoteList();
      this.set('connected', true);
    }
    getNoteList() {
      var postObj = {
        op: 'LIST_NOTES'
      };
      this.dispatch({
        type: 'WS_POST',
        payload: postObj
      })
    }
    pingSocket() {
      // for polling the server
      setInterval(function() {
        var dummyObj = {
          op: 'PING'
        };
        this.set('wsData', dummyObj);
      }.bind(this), 45000);
    }
    sendData(message) {
      let constructMessage = Object.assign(message, this.authObj);
      this.$.socket.send(constructMessage);
    }
    _onClose() {
      if (this.connected) {
        this.$.socket.open();
      }
    }
    _onError() {
      this.$.socket.close();
      this.set('connected', false);
    }
    handleSocketResponse(response) {
      var op = response.detail.op;
      var data = response.detail.data;
      this.dispatch({
        type: op,
        payload: data
      });
    }

    constructor() {
      super()
    }
    detached() {
      this.$.socket.close();
    }
  }

  window.customElements.define(ZeppelinViewer.is, ZeppelinViewer);
  </script>
  <script src="../../bower_components/ace-builds/src/ace.js"></script>
</dom-module>
